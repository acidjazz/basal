machine:
  timezone:
    America/Los_Angeles
  php:
    version: 7.0.4
  environment:
    ENVIRONMENT: testing
    APP_ENV: testing
    APP_DEBUG: true
    APP_URL: http://127.0.0.1:8000

dependencies:
  pre:
    - pecl install mongodb
    - echo "extension=mongodb.so" > /opt/circleci/php/7.0.4/etc/conf.d/mongodb.ini
    - printf "\n" | pecl install yaml-2.0.0
    - echo "extension=yaml.so" > /opt/circleci/php/7.0.4/etc/conf.d/yaml.ini
    - composer install --no-interaction
    - npm i --prefix vendor/acidjazz/larpug/node/
    - sleep 2

    # Install Selenium.
    - curl http://selenium-release.storage.googleapis.com/3.2/selenium-server-standalone-3.2.0.jar > selenium-server-standalone.jar
    - curl http://chromedriver.storage.googleapis.com/2.27/chromedriver_linux64.zip | gzip -dc > chromedriver
    - chmod +x chromedriver
    - 'java -jar selenium-server-standalone.jar -port 4444':
          background: true
    - sleep 2

    # Update Google Chrome.
    - google-chrome --version
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
    - sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb stable main" >> /etc/apt/sources.list.d/google.list'
    - sudo apt-get update
    - sudo apt-get --only-upgrade install google-chrome-stable
    - google-chrome --version
    - nohup bash -c "php ./artisan serve &"
    - sleep 2

test:
  override:
    - /bin/bash -c ./vendor/bin/phpunit
